import{b as S}from"./chunk-GZZ32I6Y.js";import{f as g}from"./chunk-SF7C3E5M.js";import{W as l,_ as u,g as y}from"./chunk-AG6NMNX5.js";import{h as A,j as c}from"./chunk-TWZW5B45.js";var s=A(g());var I=class p{constructor(e){this.indexedDbService=e;this.loadStoredApiKey()}STORAGE_KEY="ezm_gemini_api_key";ENCRYPTION_KEY="ezReaderMobile";apiKeySubject=new y(null);apiKey$=this.apiKeySubject.asObservable();setApiKey(e,o,n,i=!1){return c(this,null,function*(){try{let t;if(i){if(t=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8),!t)throw new Error("API \uD0A4 \uBCF5\uD638\uD654 \uC2E4\uD328")}else t=e;let a={apiKey:t,userId:o,email:n,expiresAt:new Date(Date.now()+720*60*60*1e3)},r=s.AES.encrypt(JSON.stringify(a),this.ENCRYPTION_KEY).toString();yield this.saveToIndexedDB(this.STORAGE_KEY,r),this.apiKeySubject.next(t),console.log("\u2705 Gemini API \uD0A4 \uC124\uC815 \uC644\uB8CC (IndexedDB):",n)}catch(t){throw console.error("\u274C API \uD0A4 \uC124\uC815 \uC2E4\uD328:",t),t}})}loadStoredApiKey(){return c(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.STORAGE_KEY);if(!e)return;let n=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8);if(!n){yield this.clearApiKey();return}let i=JSON.parse(n);if(i.expiresAt&&new Date(i.expiresAt)<new Date){console.log("\u26A0\uFE0F API \uD0A4 \uB9CC\uB8CC\uB428"),yield this.clearApiKey();return}this.apiKeySubject.next(i.apiKey),console.log("\u2705 \uC800\uC7A5\uB41C Gemini API \uD0A4 \uB85C\uB4DC \uC644\uB8CC (IndexedDB)")}catch(e){console.error("\u274C API \uD0A4 \uB85C\uB4DC \uC2E4\uD328:",e),yield this.clearApiKey()}})}getApiKey(){return this.apiKeySubject.value}getApiKeyInfo(){return c(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.STORAGE_KEY);if(!e)return null;let n=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8);return n?JSON.parse(n):null}catch(e){return console.error("\u274C API \uD0A4 \uC815\uBCF4 \uC870\uD68C \uC2E4\uD328:",e),null}})}clearApiKey(){return c(this,null,function*(){console.log("\u{1F5D1}\uFE0F API \uD0A4 \uC0AD\uC81C \uC2DC\uC791...");try{yield this.deleteFromIndexedDB(this.STORAGE_KEY),this.apiKeySubject.next(null),console.log("\u2705 Gemini API \uD0A4 \uC0AD\uC81C \uC644\uB8CC (IndexedDB)")}catch(e){throw console.error("\u274C API \uD0A4 \uC0AD\uC81C \uC2E4\uD328:",e),e}})}hasApiKey(){return!!this.apiKeySubject.value}saveToIndexedDB(e,o){return c(this,null,function*(){let t=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((a,r)=>{let d=t.put({key:e,value:o});d.onsuccess=()=>a(),d.onerror=()=>r(d.error)})})}getFromIndexedDB(e){return c(this,null,function*(){let i=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readonly").objectStore("settings");return new Promise((t,a)=>{let r=i.get(e);r.onsuccess=()=>{let d=r.result;t(d?d.value:null)},r.onerror=()=>a(r.error)})})}deleteFromIndexedDB(e){return c(this,null,function*(){let i=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((t,a)=>{let r=i.delete(e);r.onsuccess=()=>t(),r.onerror=()=>a(r.error)})})}static \u0275fac=function(o){return new(o||p)(u(S))};static \u0275prov=l({token:p,factory:p.\u0275fac,providedIn:"root"})};export{I as a};
